<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/styles/login.css" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Jomhuria&family=Sigmar&family=Sigmar+One&display=swap"
      rel="stylesheet"
    />
    <title>Reset Password - Security System</title>
  </head>
  <body>
    <div class="footer">
      <div class="container">
        <h2 class="title">Reset Password</h2>
        <form id="resetPasswordForm">
          <input
            type="password"
            id="password"
            placeholder="New Password"
            required
            minlength="6"
          />
          <input
            type="password"
            id="confirmPassword"
            placeholder="Confirm New Password"
            required
            minlength="6"
          />
          <button class="loginbutton" type="submit" id="submitButton">
            Reset Password
          </button>
        </form>
        <div id="message"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const SUPABASE_URL = "https://porcvcjxmjwpmhpvqckj.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvcmN2Y2p4bWp3cG1ocHZxY2tqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNzc4MzYsImV4cCI6MjA3Njg1MzgzNn0.r0CHtaPGHNfCe4SAm4MwBq8vAyyadYEbJhgI1g1LpEU";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const resetPasswordForm = document.getElementById("resetPasswordForm");
      const messageDiv = document.getElementById("message");
      const submitButton = document.getElementById("submitButton");

      // Handle password reset token from URL hash or query params
      async function handlePasswordResetToken() {
        try {
          // Check both hash fragment and query parameters (Supabase can use either)
          const hashParams = window.location.hash ? new URLSearchParams(window.location.hash.substring(1)) : new URLSearchParams();
          const queryParams = new URLSearchParams(window.location.search);
          
          // Try hash first, then query params
          let accessToken = hashParams.get("access_token") || queryParams.get("access_token");
          let refreshToken = hashParams.get("refresh_token") || queryParams.get("refresh_token");
          let type = hashParams.get("type") || queryParams.get("type");
          let code = queryParams.get("code");

          // Debug logging
          console.log("URL:", window.location.href);
          console.log("Hash:", window.location.hash);
          console.log("Query:", window.location.search);
          console.log("Tokens found - access_token:", !!accessToken, "refresh_token:", !!refreshToken, "type:", type, "code:", !!code);

          // Case 1: Recovery link with access + refresh tokens in URL hash
          if (accessToken && refreshToken) {
            // Set the session using the tokens from the URL
            const { data, error } = await supabase.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken
            });

            if (error) {
              throw error;
            }

            // Success - tokens are set, user can now reset password
            console.log("Password reset session established");
            messageDiv.textContent = "Please enter your new password.";
            messageDiv.style.color = "green";
            // Make sure form is visible
            resetPasswordForm.style.display = "block";
          } else if (code) {
            // Case 2: New-style link with `?code=` requires exchanging the code for a session
            const { data, error } = await supabase.auth.exchangeCodeForSession(code);
            if (error) throw error;
            console.log("Session established via code exchange");
            messageDiv.textContent = "Please enter your new password.";
            messageDiv.style.color = "green";
            resetPasswordForm.style.display = "block";
          } else {
            // No tokens found
            console.error("No tokens found in URL");
            messageDiv.textContent = "Invalid or expired reset link. Please request a new password reset.";
            messageDiv.style.color = "red";
            resetPasswordForm.style.display = "none";
          }
        } catch (error) {
          console.error("Error setting password reset session:", error);
          messageDiv.textContent = "Error: " + (error.message || error) + ". Please request a new password reset.";
          messageDiv.style.color = "red";
          resetPasswordForm.style.display = "none";
        }
      }

      // Check URL hash on page load
      window.addEventListener("load", handlePasswordResetToken);
      // Also check if hash changes
      window.addEventListener("hashchange", handlePasswordResetToken);

      resetPasswordForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

        // Validate passwords match
        if (password !== confirmPassword) {
          messageDiv.textContent = "Passwords do not match.";
          messageDiv.style.color = "red";
          return;
        }

        if (password.length < 6) {
          messageDiv.textContent = "Password must be at least 6 characters long.";
          messageDiv.style.color = "red";
          return;
        }

        messageDiv.textContent = "";
        submitButton.disabled = true;
        submitButton.textContent = "Resetting...";

        try {
          // First ensure we have a valid session
          const { data: { user }, error: userError } = await supabase.auth.getUser();
          
          if (userError || !user) {
            throw new Error("Invalid or expired reset token. Please request a new password reset.");
          }

          // Update password using Supabase client
          const { data, error } = await supabase.auth.updateUser({
            password: password
          });

          if (error) {
            throw error;
          }

          // Call backend cleanup to unlock account and clear failed attempts
          try {
            const { data: { session } } = await supabase.auth.getSession();
            if (session && session.access_token) {
              const cleanupResponse = await fetch("http://localhost:5000/api/reset-password-cleanup", {
                method: "POST",
                headers: { 
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${session.access_token}`
                }
              });
              // Don't fail if cleanup fails, just log it
              if (!cleanupResponse.ok) {
                console.warn("Cleanup endpoint failed, but password was reset successfully");
              }
            }
          } catch (cleanupError) {
            console.warn("Could not call cleanup endpoint:", cleanupError);
          }

          // Success - redirect to login
          messageDiv.textContent = "Password reset successful! Redirecting to login...";
          messageDiv.style.color = "green";
          
          setTimeout(() => {
            window.location.href = "/";
          }, 2000);

        } catch (error) {
          messageDiv.textContent = "Failed to reset password: " + (error.message || error);
          messageDiv.style.color = "red";
          submitButton.disabled = false;
          submitButton.textContent = "Reset Password";
        }
      });
    </script>
  </body>
</html>

